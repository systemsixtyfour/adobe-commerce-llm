<?php
/**
 * Generate Button Template
 * @var \System64\LlmsTxtGenerator\Block\Adminhtml\System\Config\GenerateButton $block
 */
?>
<div id="llmstxt_generate_container">
    <?= $block->getButtonHtml() ?>
    <div id="llmstxt_generate_result" style="margin-top: 10px; display: none;"></div>
</div>

<script type="text/javascript">
    require(['jquery', 'Magento_Ui/js/modal/alert'], function($, alert) {
        $('#llmstxt_generate_button').on('click', function() {
            var $button = $(this);
            var $result = $('#llmstxt_generate_result');

            $button.prop('disabled', true).text('<?= __('Generating...') ?>');
            $result.hide();

            $.ajax({
                url: '<?= $block->escapeUrl($block->getGenerateUrl()) ?>',
                type: 'POST',
                dataType: 'json',
                data: {
                    form_key: FORM_KEY
                },
                success: function(response) {
                    $button.prop('disabled', false).text('<?= __('Generate Now') ?>');

                    if (response.success) {
                        $result.html(
                            '<div style="padding: 10px; background: #e8f5e9; border-radius: 4px; border: 1px solid #4caf50;">' +
                            '<strong style="color: #2e7d32;">✓ ' + response.message + '</strong>' +
                            (response.url ? '<br><a href="' + response.url + '" target="_blank">View llms.txt →</a>' : '') +
                            '</div>'
                        ).show();

                        // Refresh the page after 2 seconds to update status
                        setTimeout(function() {
                            location.reload();
                        }, 2000);
                    } else {
                        $result.html(
                            '<div style="padding: 10px; background: #ffebee; border-radius: 4px; border: 1px solid #f44336;">' +
                            '<strong style="color: #c62828;">✗ ' + response.message + '</strong>' +
                            '</div>'
                        ).show();
                    }
                },
                error: function(xhr, status, error) {
                    $button.prop('disabled', false).text('<?= __('Generate Now') ?>');
                    $result.html(
                        '<div style="padding: 10px; background: #ffebee; border-radius: 4px; border: 1px solid #f44336;">' +
                        '<strong style="color: #c62828;">✗ Error: ' + error + '</strong>' +
                        '</div>'
                    ).show();
                }
            });
        });
    });
</script>
